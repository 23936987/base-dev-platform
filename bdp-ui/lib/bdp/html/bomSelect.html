<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>

</head>
<body>
<div id="ajax-loader" style="cursor: progress; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; background: #fff; z-index: 10000; overflow: hidden;">
    <img src="/base/images/ajax-loader.gif" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; margin: auto;" />
</div>
<div id="mainBodyContent">
</div>
<!--#include file="/base/common.shtml"-->
<link rel="stylesheet" type="text/css" href="/lib/bootstrap-table/bootstrap-table.css" rel="stylesheet" />
<script type="text/javascript" src="/lib/bootstrap-table/bootstrap-table.js"></script>
<script type="text/javascript" src="/lib/bootstrap-table/locale/bootstrap-table-zh-CN.js"></script>
<link rel="stylesheet" href="/lib/ztree/css/metroStyle/metroStyle.css" type="text/css">
<script type="text/javascript" src="/lib/ztree/js/jquery.ztree.all.min.js"></script>

<script type="text/javascript"  src="/base/js/global.js"></script>
<script type="text/javascript"  src="/base/js/base/base.js"></script>
<script type="text/javascript"  src="/base/js/base/list.js"></script>
<script>
    (function (_$,ctx,window) {
        window.config;
        window.value;
        window._init=function(data,defValue){
            config=data;
            value = defValue;
            ctx.pageTemplate();

        };
        var treeObj;
        var setting;
        function _initTree(){
            setting = {
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "parentId",
                        rootPId: null
                    }
                },
                callback: {
                    onClick: onClickTreeNode
                },
                view: {
                    showLine:false
                }
            };


            var params=config["params"];


            $.ajax({
                url:  "/hqx/bomType/bomSelect",
                data:params,
                type: "POST",
                dataType:'text',
                success: function(responseText){
                    var result = JSonDtoModel.restore(responseText);
                    var data = result.get("nodes");
                    treeObj = $.fn.zTree.init($("#tree"), setting, data);
            }});


        }

        function onClickTreeNode(event, treeId, treeNode,map) {
            if(treeNode && treeNode.id){
                var id = treeNode.id;
                _$.getById("bomTypeId").setValue(id);
                search();
            }
            return false;
        }
        ctx._initList = function(){
            new _$.Layout($("#content"),{
                spacing_open:5,
                west__closable:true
            });
            _initTree();

            var addUrl = config["addUrl"];
            if(isNotEmpty(addUrl)){
                $(".addBtn").show();
            }

            var idField=config["idField"];
            var textField=config["textField"];
            if(isNotEmpty(value)){
                var ids =  value["ids"] + '';
                var names =  value["names"];

                var idArr = ids.split(",");
                var namesArr = names.split(",");

                if(idArr != null && idArr.length > 0){
                    idArr.each(function(id,index){
                        var item = {};
                        item[idField] = id;
                        item[textField] = namesArr[index];
                        checkHandler(item);
                    });
                }
            }
        };
        ctx._initTable=function(){
            var opt = {
                search:true,
                import:false,
                export:false,
                multipleSearch:false,
                showColumns: false, //是否显示所有的列,
                onCheck:checkHandler,
                onUncheck:unCheckHandler,
                onCheckAll:onCheckAllHandler,
                onUncheckAll:onUncheckAllHandler,
                onPostBody:onPostBodyHandler
            };

            var idField=config["idField"];
            var textField=config["textField"];
            var multiple=config["multiple"];
            var listUrl=config["listUrl"];
            var columns=config["columns"];
            var params=config["params"];

            if(params){
                window.previous_params = params;
            }

            opt["idField"]=idField;
            if(multiple){
                opt["singleSelect"]=false;
            }else{
                opt["singleSelect"]=true;
            }

            if(isEmpty(listUrl)){
                _$.notify.error("没有配置对象访问地址");
                return;
            }else{
                opt["url"] = listUrl;
            }
            if(isEmpty(columns) || columns.length==0){
                _$.notify.error("没有配置列展示");
                return;
            }else{
                opt["columns"] = columns;
            }
            ctx._initPagination(opt);
        };

        window.checkArr = [];
        var checkHandler = function(row){
            var idField=config["idField"];
            var textField=config["textField"];
            var multiple=config["multiple"];
            var id = row[idField];

            if(multiple){
                var flag = checkArr.some(function(item,i){
                    if(item[idField] == id){
                        return true;
                    }
                    return false;
                });

                if(!flag){
                    var $checkContainer = $(".east");
                    var _Text_ = row[textField];

                   // var _html = '<div class="query" id="checkItem_'+id+'"><span>'+_Text_+'</span><i onclick="deleteItem('+id+')"></i></div> ';
                    var _html = '<div class="query" id="checkItem_'+id+'"><span title="'+_Text_+'">'+_Text_+'</span><i  onclick="deleteItem('+id+')"></i></div>';
                    $checkContainer.append(_html);
                    var item = {};
                    item[idField] = id;
                    item[textField] = _Text_;
                    item["row"] = row;
                    checkArr.add(item);
                }
            }else{
                var hasSelect = (checkArr.length > 0);

                if(hasSelect){
                    unCheckHandler(checkArr[0]);
                }
                var $checkContainer = $(".east");
                var _Text_ = row[textField];
                var _html = '<div class="query" id="checkItem_'+id+'"><span>'+_Text_+'</span><i onclick="deleteItem('+id+')"></i></div> ';
                $checkContainer.append(_html);
                var item = {};
                item[idField] = id;
                item[textField] = _Text_;
                item["row"] = row;
                checkArr.add(item);
            }
        };
        var unCheckHandler=function(row){
            var idField=config["idField"];
            var id = row[idField];
            if(checkArr.length>0){
                 var item = checkArr.getElementById(id);
                if(item){
                    var $checkContainer = $(".east");
                    $('#checkItem_'+id,$checkContainer).remove();
                    checkArr.removeById(item.id);
                }
            }
        };
        var onCheckAllHandler=function(rows){
            if(rows != null && rows.length>0){
                rows.each(function(row,i){
                    checkHandler(row);
                })
            }
        };
        var onUncheckAllHandler=function(rows){
            if(rows != null && rows.length>0){
                rows.each(function(row,i){
                    unCheckHandler(row);
                })
            }
        };
        var onPostBodyHandler=function(){
            var idField=config["idField"];
            var ids = [];

            checkArr.each(function(item){
                var id = item[idField];
                ids.add(_$.parseInt(id));
            });

            $('#dataTable').bootstrapTable('checkBy',{field:idField, values:ids});
        };
        window.deleteItem = function(id){
            var idField=config["idField"];
            var item = checkArr.getElementById(id);
            if(item){
                var $checkContainer = $(".east");
                $('#checkItem_'+id,$checkContainer).remove();
                checkArr.remove(item);

                $('#dataTable').bootstrapTable('uncheckBy',{field:idField, values:[id]});
            }
        }

        window.getReturnValue=function(i){
            var idField=config["idField"];
            var textField=config["textField"];
            var res = {};
            var ids = [];
            var names = [];
            var rows = [];
            checkArr.each(function(item){
                var id = item[idField];
                var name = item[textField];
                var row = item["row"];

                ids.add(id);
                names.add(name);
                rows.add(row);
            });

            res["ids"] = ids.join(",");
            res["names"] = names.join(",");
            res["rows"] = rows;

            return res;
        }

        window.add=function(){
            var url= config['addUrl'];
            var addParams = config["addParams"];

            var title = '新增';
            $.cc.open({
                type : 2, //page层
                area : [ width, height ],
                offset: [ '0px', '0px'],
                title : title,
                content : url,
                success: function(layero, index){
                    var win = getTopWindow();
                    var iframeWin = win[layero.find('iframe')[0]['name']];
                    iframeWin['parentWin'] = window;
                    iframeWin['windowIndex'] = index;
                    iframeWin._init(addParams);
                },
                btn : [ '确认', '取消' ],
                yes : function(index, layero) {//确认按钮调用yes方法  取消按钮的方法为cancel
                    var win = getTopWindow();
                    var iframeWin = win[layero.find('iframe')[0]['name']];
                    iframeWin.save(index);
                }
            });
        };


    })(CC,CC.ctx,window);
</script>

<style>
    #content .east {
        border: solid 1px #ccc;
        padding-top: 2px;
        position:absolute;
        top:0px;
        bottom:0px;
        right:1px;
        width: 200px;
        overflow: auto;
    }
    #content .inner{
        position:absolute;
        top:0px;
        left:0px;
        right:200px;
        overflow: hidden;
    }


    /*query*/
    .query-box{
        border:1px solid #999;
    }
    .query{
        width:190px;
        height:25px;
        background:url(/lib/component/images/popupbg.png) ;
        border:1px solid #ccc;
        box-sizing: border-box;
        border-radius: 3px;
        position:relative;
        margin-top:2px;
        margin-left:2px;
        padding-right:23px;
        float:left;
    }
    .query>span{
        width:100%;
        height:100%;
        font-size:14px;
        line-height:25px;
        white-space: nowrap;
        overflow: hidden;
        padding-left:3px;
        box-sizing: border-box;
        display: inline-block;
    }
    .query>i{
        width:22px;
        height:25px;
        background: url(/lib/component/images/delete-icon.png) no-repeat center;
        display: inline-block;
        cursor: pointer;
        position:absolute;
        right: 0;
        top:0;
    }
    .query>i:hover{
        background: url(/lib/component/images/delete-icon-g.png) no-repeat center;
    }
    /*query*/


</style>
</body>
</html>
<script id="body-content-template" type="text/x-handlebars-template">
    <div id="content">
        <div class="ui-layout-center" >

            <form id="queryForm" class="qry_form_area" style="display: none;">
                <div id="bomTypeId_type" name="params['bomTypeId'].type" initValue="0" class="cc-Hidden" model="1"></div>
                <div id="bomTypeId" name="params['bomTypeId'].value" class="cc-Hidden" model="1"></div>
            </form>
            <div id="toolbar" class="btn-group" >
                <button class="addBtn"  style="display:none;" type="button" class="btn btn-default" onclick="add()">  <span class="glyphicon glyphicon-plus"></span>添加</button>
            </div>
            <div class="inner">
                <div class="container-fluid">
                    <table id="dataTable"></table>
                </div>
            </div>
            <div class="east query-box">
            </div>
        </div>
        <div class="ui-layout-west">
            <ul id="tree" class="ztree"></ul>
        </div>
    </div>
</script>